--[[
    Rayfield Pixel Perfect - EXAKTE Positionen
    ‚ö°Ô∏è Keine Bugs mehr
    üìè Pixel-genaue Positionierung
    üéØ Alles exakt platziert
]]

-- Services
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

-- Rayfield Library
local Rayfield = {}

-- Clean Theme
Rayfield.Themes = {
    PinkSharp = {
        Background = Color3.fromRGB(13, 13, 15),
        Topbar = Color3.fromRGB(20, 20, 23),
        Card = Color3.fromRGB(25, 25, 28),
        CardHover = Color3.fromRGB(32, 32, 36),
        Primary = Color3.fromRGB(255, 105, 180),
        Text = Color3.fromRGB(245, 245, 245),
        Border = Color3.fromRGB(45, 45, 50)
    }
}

Rayfield.CurrentTheme = "PinkSharp"

-- Helper Functions
local function GetTheme()
    return Rayfield.Themes[Rayfield.CurrentTheme]
end

local function CreateTween(obj, props, duration)
    return TweenService:Create(obj, TweenInfo.new(duration or 0.2), props)
end

local function CreateFrame(parent, sizeX, sizeY, posX, posY, color, radius)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, sizeX, 0, sizeY)
    frame.Position = UDim2.new(0, posX, 0, posY)
    frame.BackgroundColor3 = color
    frame.BorderSizePixel = 0
    
    if radius then
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, radius)
        corner.Parent = frame
    end
    
    if parent then
        frame.Parent = parent
    end
    
    return frame
end

local function CreateText(parent, text, sizeX, sizeY, posX, posY, size, bold)
    local label = Instance.new("TextLabel")
    label.Text = text
    label.Size = UDim2.new(0, sizeX, 0, sizeY)
    label.Position = UDim2.new(0, posX, 0, posY)
    label.BackgroundTransparency = 1
    label.TextColor3 = GetTheme().Text
    label.TextSize = size or 14
    label.Font = bold and Enum.Font.GothamSemibold or Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    
    if parent then
        label.Parent = parent
    end
    
    return label
end

local function CreateButton(parent, text, sizeX, sizeY, posX, posY, color, radius)
    local button = Instance.new("TextButton")
    button.Text = text
    button.Size = UDim2.new(0, sizeX, 0, sizeY)
    button.Position = UDim2.new(0, posX, 0, posY)
    button.BackgroundColor3 = color
    button.TextColor3 = Color3.new(1, 1, 1)
    button.TextSize = 14
    button.Font = Enum.Font.GothamBold
    button.BorderSizePixel = 0
    
    if radius then
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, radius)
        corner.Parent = button
    end
    
    if parent then
        button.Parent = parent
    end
    
    return button
end

-- Main Window
function Rayfield.CreateWindow(settings)
    settings = settings or {}
    
    -- Clean old
    for _, gui in pairs(game.CoreGui:GetChildren()) do
        if gui.Name == "RayfieldExact" then
            gui:Destroy()
        end
    end
    
    -- ScreenGui
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "RayfieldExact"
    ScreenGui.DisplayOrder = 999
    
    if syn and syn.protect_gui then
        syn.protect_gui(ScreenGui)
    end
    
    ScreenGui.Parent = game.CoreGui
    
    -- MAIN WINDOW (500x400, centered)
    local Main = CreateFrame(ScreenGui, 500, 400, 
        (workspace.CurrentCamera.ViewportSize.X / 2) - 250,
        (workspace.CurrentCamera.ViewportSize.Y / 2) - 200,
        GetTheme().Background, 10)
    
    -- TOPBAR (500x40, top)
    local Topbar = CreateFrame(Main, 500, 40, 0, 0, GetTheme().Topbar, 10)
    
    -- Topbar corner (top only)
    local TopbarCorner = Instance.new("UICorner")
    TopbarCorner.CornerRadius = UDim.new(0, 10, 0, 0)
    TopbarCorner.Parent = Topbar
    
    -- TITLE (470x40, 15px from left)
    local Title = CreateText(Topbar, settings.Name or "Rayfield", 470, 40, 15, 0, 16, true)
    
    -- MINIMIZE BUTTON (30x30, 445px from left, 5px from top)
    local MinimizeBtn = CreateButton(Topbar, "_", 30, 30, 445, 5, GetTheme().Primary, 6)
    
    -- CLOSE BUTTON (30x30, 475px from left, 5px from top)
    local CloseBtn = CreateButton(Topbar, "√ó", 30, 30, 475, 5, Color3.fromRGB(220, 60, 60), 6)
    
    -- SIDEBAR (150x350, 10px from top, 10px from left)
    local Sidebar = CreateFrame(Main, 150, 350, 10, 40, GetTheme().Card, 8)
    
    -- Tab List (140x340, 5px padding)
    local TabList = Instance.new("ScrollingFrame")
    TabList.Size = UDim2.new(0, 140, 0, 340)
    TabList.Position = UDim2.new(0, 5, 0, 5)
    TabList.BackgroundTransparency = 1
    TabList.ScrollBarThickness = 4
    TabList.ScrollBarImageColor3 = GetTheme().Primary
    TabList.AutomaticCanvasSize = Enum.AutomaticSize.Y
    TabList.Parent = Sidebar
    
    local TabListLayout = Instance.new("UIListLayout")
    TabListLayout.Padding = UDim.new(0, 8)
    TabListLayout.Parent = TabList
    
    -- CONTENT AREA (340x350, 160px from left, 40px from top)
    local ContentArea = CreateFrame(Main, 340, 350, 160, 40, GetTheme().Card, 8)
    
    -- Content Scroller (330x340, 5px padding)
    local ContentScroller = Instance.new("ScrollingFrame")
    ContentScroller.Size = UDim2.new(0, 330, 0, 340)
    ContentScroller.Position = UDim2.new(0, 5, 0, 5)
    ContentScroller.BackgroundTransparency = 1
    ContentScroller.ScrollBarThickness = 4
    ContentScroller.ScrollBarImageColor3 = GetTheme().Primary
    ContentScroller.AutomaticCanvasSize = Enum.AutomaticSize.Y
    ContentScroller.Parent = ContentArea
    
    local ContentLayout = Instance.new("UIListLayout")
    ContentLayout.Padding = UDim.new(0, 10)
    ContentLayout.Parent = ContentScroller
    
    -- Variables
    local Tabs = {}
    local CurrentTab = nil
    local IsDragging = false
    local DragStart = Vector2.new(0, 0)
    local IsMinimized = false
    
    -- Window Dragging
    Topbar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            IsDragging = true
            DragStart = input.Position
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if IsDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local mousePos = input.Position
            Main.Position = UDim2.new(0, mousePos.X - DragStart.X, 0, mousePos.Y - DragStart.Y)
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            IsDragging = false
        end
    end)
    
    -- Close Button
    CloseBtn.MouseButton1Click:Connect(function()
        CreateTween(Main, {Size = UDim2.new(0, 0, 0, 0)}):Play()
        task.wait(0.3)
        ScreenGui:Destroy()
    end)
    
    -- Minimize Button
    MinimizeBtn.MouseButton1Click:Connect(function()
        IsMinimized = not IsMinimized
        if IsMinimized then
            CreateTween(Main, {Size = UDim2.new(0, 500, 0, 40)}):Play()
            Sidebar.Visible = false
            ContentArea.Visible = false
        else
            CreateTween(Main, {Size = UDim2.new(0, 500, 0, 400)}):Play()
            Sidebar.Visible = true
            ContentArea.Visible = true
        end
    end)
    
    -- Window Object
    local Window = {}
    
    -- Create Tab
    function Window:CreateTab(name)
        local Tab = {}
        
        -- Tab Button (140x40)
        local TabButton = CreateFrame(nil, 140, 40, 0, 0, GetTheme().Card, 6)
        TabButton.Name = name
        
        local TabLabel = CreateText(TabButton, name, 120, 40, 10, 0, 14, true)
        
        local TabBtn = Instance.new("TextButton")
        TabBtn.Size = UDim2.new(1, 0, 1, 0)
        TabBtn.BackgroundTransparency = 1
        TabBtn.Text = ""
        TabBtn.Parent = TabButton
        
        TabButton.Parent = TabList
        
        -- Tab Content (330x0, hidden)
        local TabContent = Instance.new("Frame")
        TabContent.Name = name
        TabContent.Size = UDim2.new(0, 330, 0, 0)
        TabContent.BackgroundTransparency = 1
        TabContent.Visible = false
        TabContent.Parent = ContentScroller
        
        local TabLayout = Instance.new("UIListLayout")
        TabLayout.Padding = UDim.new(0, 10)
        TabLayout.Parent = TabContent
        
        -- Tab Selection
        TabBtn.MouseButton1Click:Connect(function()
            if CurrentTab then
                CurrentTab.Visible = false
            end
            
            -- Reset all tabs
            for _, btn in pairs(TabList:GetChildren()) do
                if btn:IsA("Frame") then
                    btn.BackgroundColor3 = GetTheme().Card
                    if btn:FindFirstChildWhichIsA("TextLabel") then
                        btn:FindFirstChildWhichIsA("TextLabel").TextColor3 = GetTheme().Text
                    end
                end
            end
            
            -- Highlight active
            TabButton.BackgroundColor3 = GetTheme().Primary
            TabLabel.TextColor3 = Color3.new(1, 1, 1)
            
            -- Show content
            TabContent.Visible = true
            CurrentTab = TabContent
        end)
        
        -- First tab active
        if #TabList:GetChildren() == 1 then
            task.wait(0.1)
            TabBtn:Fire()
        end
        
        -- Create Button
        function Tab:CreateButton(settings)
            local Button = CreateFrame(TabContent, 320, 40, 0, 0, GetTheme().Card, 6)
            Button.Name = settings.Name
            
            local ButtonLabel = CreateText(Button, settings.Name, 300, 40, 10, 0, 14, true)
            
            local Btn = Instance.new("TextButton")
            Btn.Size = UDim2.new(1, 0, 1, 0)
            Btn.BackgroundTransparency = 1
            Btn.Text = ""
            Btn.Parent = Button
            
            -- Hover
            Btn.MouseEnter:Connect(function()
                Button.BackgroundColor3 = GetTheme().CardHover
            end)
            
            Btn.MouseLeave:Connect(function()
                Button.BackgroundColor3 = GetTheme().Card
            end)
            
            -- Click
            Btn.MouseButton1Click:Connect(function()
                local original = Button.BackgroundColor3
                Button.BackgroundColor3 = GetTheme().Primary
                task.wait(0.1)
                Button.BackgroundColor3 = original
                
                if settings.Callback then
                    pcall(settings.Callback)
                end
            end)
            
            local ButtonObj = {}
            function ButtonObj:Set(newName)
                Button.Name = newName
                ButtonLabel.Text = newName
            end
            
            return ButtonObj
        end
        
        -- Create Toggle
        function Tab:CreateToggle(settings)
            local Toggle = CreateFrame(TabContent, 320, 40, 0, 0, GetTheme().Card, 6)
            Toggle.Name = settings.Name
            
            local ToggleLabel = CreateText(Toggle, settings.Name, 240, 40, 10, 0, 14, true)
            
            -- Toggle Switch (50x25)
            local Switch = CreateFrame(Toggle, 50, 25, 260, 8, GetTheme().CardHover, 25)
            
            local Knob = CreateFrame(Switch, 20, 20, 3, 3, GetTheme().Text, 25)
            
            local ToggleBtn = Instance.new("TextButton")
            ToggleBtn.Size = UDim2.new(1, 0, 1, 0)
            ToggleBtn.BackgroundTransparency = 1
            ToggleBtn.Text = ""
            ToggleBtn.Parent = Toggle
            
            local State = settings.CurrentValue or false
            
            local function UpdateToggle()
                if State then
                    Knob.Position = UDim2.new(0, 27, 0, 3)
                    Knob.BackgroundColor3 = GetTheme().Primary
                else
                    Knob.Position = UDim2.new(0, 3, 0, 3)
                    Knob.BackgroundColor3 = GetTheme().Text
                end
            end
            
            UpdateToggle()
            
            -- Click
            ToggleBtn.MouseButton1Click:Connect(function()
                State = not State
                UpdateToggle()
                
                if settings.Callback then
                    pcall(settings.Callback, State)
                end
            end)
            
            local ToggleObj = {}
            function ToggleObj:Set(value)
                State = value
                UpdateToggle()
            end
            
            return ToggleObj
        end
        
        -- Create Label
        function Tab:CreateLabel(text)
            local Label = CreateFrame(TabContent, 320, 30, 0, 0, GetTheme().Card, 6)
            
            CreateText(Label, text, 300, 30, 10, 0, 14, false)
            
            local LabelObj = {}
            function LabelObj:Set(newText)
                if Label:FindFirstChildWhichIsA("TextLabel") then
                    Label:FindFirstChildWhichIsA("TextLabel").Text = newText
                end
            end
            
            return LabelObj
        end
        
        table.insert(Tabs, Tab)
        return Tab
    end
    
    -- Window Controls
    function Window:Hide()
        Main.Visible = false
    end
    
    function Window:Show()
        Main.Visible = true
    end
    
    -- Keybind
    if settings.ToggleKey then
        UserInputService.InputBegan:Connect(function(input, processed)
            if not processed and input.KeyCode == Enum.KeyCode[settings.ToggleKey] then
                Main.Visible = not Main.Visible
            end
        end)
    end
    
    return Window
end

return Rayfield
