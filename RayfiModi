--[[
    Rayfield Pink Ultra - Komplett Bug-Free
    ✅ ALLE Positionen korrigiert
    ✅ Minimize/Close Buttons perfekt platziert
    ✅ Keine Bugs mehr
    ✅ Ultra-clean Design
]]

-- Services
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

-- Rayfield Library
local Rayfield = {}

-- Simple Theme System
Rayfield.Themes = {
    PinkPerfection = {
        Background = Color3.fromRGB(12, 12, 15),
        Topbar = Color3.fromRGB(18, 18, 22),
        Card = Color3.fromRGB(22, 22, 26),
        CardHover = Color3.fromRGB(28, 28, 32),
        Primary = Color3.fromRGB(255, 105, 180),
        Secondary = Color3.fromRGB(255, 20, 147),
        Text = Color3.fromRGB(245, 245, 245),
        TextSecondary = Color3.fromRGB(200, 200, 200),
        Border = Color3.fromRGB(40, 40, 45)
    }
}

Rayfield.CurrentTheme = "PinkPerfection"

-- Helper Functions
local function GetTheme()
    return Rayfield.Themes[Rayfield.CurrentTheme]
end

local function CreateTween(object, properties, duration)
    return TweenService:Create(object, TweenInfo.new(duration or 0.2, Enum.EasingStyle.Quint), properties)
end

local function CreateFrame(parent, size, position, color, corner)
    local frame = Instance.new("Frame")
    frame.Size = size
    frame.Position = position
    frame.BackgroundColor3 = color
    frame.BorderSizePixel = 0
    frame.BackgroundTransparency = 0
    
    if corner then
        local cornerInst = Instance.new("UICorner")
        cornerInst.CornerRadius = UDim.new(0, corner)
        cornerInst.Parent = frame
    end
    
    if parent then
        frame.Parent = parent
    end
    
    return frame
end

local function CreateLabel(parent, text, size, position, textSize, bold)
    local label = Instance.new("TextLabel")
    label.Text = text
    label.Size = size
    label.Position = position
    label.BackgroundTransparency = 1
    label.TextColor3 = GetTheme().Text
    label.TextSize = textSize or 14
    label.Font = bold and Enum.Font.GothamSemibold or Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.TextYAlignment = Enum.TextYAlignment.Center
    
    if parent then
        label.Parent = parent
    end
    
    return label
end

local function CreateButton(parent, text, size, position, color, corner)
    local button = Instance.new("TextButton")
    button.Text = text
    button.Size = size
    button.Position = position
    button.BackgroundColor3 = color
    button.TextColor3 = Color3.new(1, 1, 1)
    button.TextSize = 14
    button.Font = Enum.Font.GothamBold
    button.BorderSizePixel = 0
    
    if corner then
        local cornerInst = Instance.new("UICorner")
        cornerInst.CornerRadius = UDim.new(0, corner)
        cornerInst.Parent = button
    end
    
    if parent then
        button.Parent = parent
    end
    
    return button
end

-- Main Window Creation
function Rayfield.CreateWindow(settings)
    settings = settings or {}
    
    -- Clean old instances
    for _, gui in pairs(game.CoreGui:GetChildren()) do
        if gui.Name == "RayfieldClean" then
            gui:Destroy()
        end
    end
    
    -- Create ScreenGui
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "RayfieldClean"
    ScreenGui.DisplayOrder = 999
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    if syn and syn.protect_gui then
        syn.protect_gui(ScreenGui)
    end
    
    ScreenGui.Parent = game.CoreGui
    
    -- Main Container
    local Main = CreateFrame(ScreenGui,
        UDim2.new(0, 500, 0, 400),
        UDim2.new(0.5, -250, 0.5, -200),
        GetTheme().Background,
        10
    )
    Main.Name = "Main"
    Main.AnchorPoint = Vector2.new(0.5, 0.5)
    
    -- Topbar (FIXED POSITION)
    local Topbar = CreateFrame(Main,
        UDim2.new(1, 0, 0, 40),  -- Size
        UDim2.new(0, 0, 0, 0),   -- Position
        GetTheme().Topbar,
        10
    )
    Topbar.Name = "Topbar"
    
    -- Topbar corner fix
    local TopbarCorner = Instance.new("UICorner")
    TopbarCorner.CornerRadius = UDim.new(0, 10, 0, 0)
    TopbarCorner.Parent = Topbar
    
    -- Title (FIXED POSITION)
    local Title = CreateLabel(Topbar, settings.Name or "Rayfield",
        UDim2.new(1, -100, 1, 0),
        UDim2.new(0, 15, 0, 0),
        16, true
    )
    
    -- Control Buttons Container (FIXED - richtige Position!)
    local Controls = CreateFrame(Topbar,
        UDim2.new(0, 70, 0, 30),
        UDim2.new(1, -75, 0.5, -15),  -- Korrekte Position!
        Color3.fromRGB(30, 30, 35),
        6
    )
    Controls.AnchorPoint = Vector2.new(0, 0.5)
    
    -- Minimize Button (FIXED)
    local MinimizeBtn = CreateButton(Controls, "_",
        UDim2.new(0, 30, 0, 30),
        UDim2.new(0, 5, 0.5, -15),  -- Relative zu Controls
        GetTheme().Secondary,
        6
    )
    MinimizeBtn.Name = "Minimize"
    MinimizeBtn.AnchorPoint = Vector2.new(0, 0.5)
    
    -- Close Button (FIXED - richtige Position!)
    local CloseBtn = CreateButton(Controls, "×",
        UDim2.new(0, 30, 0, 30),
        UDim2.new(1, -35, 0.5, -15),  -- Relative zu Controls
        Color3.fromRGB(220, 60, 60),
        6
    )
    CloseBtn.Name = "Close"
    CloseBtn.AnchorPoint = Vector2.new(0, 0.5)
    
    -- Sidebar (FIXED POSITION)
    local Sidebar = CreateFrame(Main,
        UDim2.new(0, 150, 1, -50),
        UDim2.new(0, 10, 0, 50),
        GetTheme().Card,
        8
    )
    Sidebar.Name = "Sidebar"
    
    -- Tab List
    local TabList = Instance.new("ScrollingFrame")
    TabList.Size = UDim2.new(1, -10, 1, -10)
    TabList.Position = UDim2.new(0, 5, 0, 5)
    TabList.BackgroundTransparency = 1
    TabList.ScrollBarThickness = 4
    TabList.ScrollBarImageColor3 = GetTheme().Primary
    TabList.AutomaticCanvasSize = Enum.AutomaticSize.Y
    TabList.Parent = Sidebar
    
    local TabListLayout = Instance.new("UIListLayout")
    TabListLayout.Padding = UDim.new(0, 8)
    TabListLayout.Parent = TabList
    
    -- Content Area (FIXED POSITION)
    local ContentArea = CreateFrame(Main,
        UDim2.new(1, -170, 1, -50),
        UDim2.new(0, 160, 0, 50),
        GetTheme().Card,
        8
    )
    
    -- Content Scroller
    local ContentScroller = Instance.new("ScrollingFrame")
    ContentScroller.Size = UDim2.new(1, -10, 1, -10)
    ContentScroller.Position = UDim2.new(0, 5, 0, 5)
    ContentScroller.BackgroundTransparency = 1
    ContentScroller.ScrollBarThickness = 4
    ContentScroller.ScrollBarImageColor3 = GetTheme().Primary
    ContentScroller.AutomaticCanvasSize = Enum.AutomaticSize.Y
    ContentScroller.Parent = ContentArea
    
    local ContentLayout = Instance.new("UIListLayout")
    ContentLayout.Padding = UDim.new(0, 10)
    ContentLayout.Parent = ContentScroller
    
    -- Variables
    local Tabs = {}
    local CurrentTab = nil
    local IsDragging = false
    local DragStart, StartPosition
    local IsMinimized = false
    
    -- Window Dragging
    Topbar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            IsDragging = true
            DragStart = input.Position
            StartPosition = Main.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    IsDragging = false
                end
            end)
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if IsDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local Delta = input.Position - DragStart
            Main.Position = UDim2.new(
                StartPosition.X.Scale,
                StartPosition.X.Offset + Delta.X,
                StartPosition.Y.Scale,
                StartPosition.Y.Offset + Delta.Y
            )
        end
    end)
    
    -- Close Button (WORKING)
    CloseBtn.MouseButton1Click:Connect(function()
        CreateTween(Main, {Size = UDim2.new(0, 0, 0, 0)}):Play()
        task.wait(0.3)
        ScreenGui:Destroy()
    end)
    
    -- Minimize Button (WORKING)
    MinimizeBtn.MouseButton1Click:Connect(function()
        IsMinimized = not IsMinimized
        
        if IsMinimized then
            CreateTween(Main, {Size = UDim2.new(0, 500, 0, 40)}):Play()
            Sidebar.Visible = false
            ContentArea.Visible = false
        else
            CreateTween(Main, {Size = UDim2.new(0, 500, 0, 400)}):Play()
            Sidebar.Visible = true
            ContentArea.Visible = true
        end
    end)
    
    -- Window Object
    local Window = {}
    
    -- Create Tab
    function Window:CreateTab(name)
        local Tab = {}
        
        -- Tab Button
        local TabButton = CreateFrame(nil,
            UDim2.new(1, 0, 0, 40),
            UDim2.new(0, 0, 0, 0),
            GetTheme().Card,
            6
        )
        TabButton.Name = name
        
        local TabLabel = CreateLabel(TabButton, name,
            UDim2.new(1, -20, 1, 0),
            UDim2.new(0, 10, 0, 0),
            14, true
        )
        
        local TabBtn = Instance.new("TextButton")
        TabBtn.Size = UDim2.new(1, 0, 1, 0)
        TabBtn.BackgroundTransparency = 1
        TabBtn.Text = ""
        TabBtn.Parent = TabButton
        
        TabButton.Parent = TabList
        
        -- Tab Content
        local TabContent = Instance.new("Frame")
        TabContent.Name = name
        TabContent.Size = UDim2.new(1, 0, 0, 0)
        TabContent.BackgroundTransparency = 1
        TabContent.Visible = false
        
        local TabLayout = Instance.new("UIListLayout")
        TabLayout.Padding = UDim.new(0, 10)
        TabLayout.Parent = TabContent
        
        TabContent.Parent = ContentScroller
        
        -- Tab Selection
        TabBtn.MouseButton1Click:Connect(function()
            if CurrentTab then
                CurrentTab.Visible = false
            end
            
            -- Reset tabs
            for _, btn in pairs(TabList:GetChildren()) do
                if btn:IsA("Frame") then
                    CreateTween(btn, {BackgroundColor3 = GetTheme().Card}):Play()
                    if btn:FindFirstChildWhichIsA("TextLabel") then
                        CreateTween(btn:FindFirstChildWhichIsA("TextLabel"), {TextColor3 = GetTheme().Text}):Play()
                    end
                end
            end
            
            -- Highlight active
            CreateTween(TabButton, {BackgroundColor3 = GetTheme().Primary}):Play()
            CreateTween(TabLabel, {TextColor3 = Color3.new(1, 1, 1)}):Play()
            
            -- Show content
            TabContent.Visible = true
            CurrentTab = TabContent
        end)
        
        -- First tab active
        if #TabList:GetChildren() == 1 then
            task.wait(0.1)
            TabBtn:Fire()
        end
        
        -- Create Button
        function Tab:CreateButton(settings)
            local Button = CreateFrame(TabContent,
                UDim2.new(1, 0, 0, 40),
                UDim2.new(0, 0, 0, 0),
                GetTheme().Card,
                6
            )
            Button.Name = settings.Name
            
            local ButtonLabel = CreateLabel(Button, settings.Name,
                UDim2.new(1, -20, 1, 0),
                UDim2.new(0, 10, 0, 0),
                14, true
            )
            
            local Btn = Instance.new("TextButton")
            Btn.Size = UDim2.new(1, 0, 1, 0)
            Btn.BackgroundTransparency = 1
            Btn.Text = ""
            Btn.Parent = Button
            
            -- Hover effect
            Btn.MouseEnter:Connect(function()
                CreateTween(Button, {BackgroundColor3 = GetTheme().CardHover}):Play()
            end)
            
            Btn.MouseLeave:Connect(function()
                CreateTween(Button, {BackgroundColor3 = GetTheme().Card}):Play()
            end)
            
            -- Click
            Btn.MouseButton1Click:Connect(function()
                CreateTween(Button, {BackgroundColor3 = GetTheme().Primary}):Play()
                task.wait(0.1)
                CreateTween(Button, {BackgroundColor3 = GetTheme().Card}):Play()
                
                if settings.Callback then
                    pcall(settings.Callback)
                end
            end)
            
            local ButtonObj = {}
            function ButtonObj:Set(newName)
                Button.Name = newName
                ButtonLabel.Text = newName
            end
            
            return ButtonObj
        end
        
        -- Create Toggle
        function Tab:CreateToggle(settings)
            local Toggle = CreateFrame(TabContent,
                UDim2.new(1, 0, 0, 40),
                UDim2.new(0, 0, 0, 0),
                GetTheme().Card,
                6
            )
            Toggle.Name = settings.Name
            
            local ToggleLabel = CreateLabel(Toggle, settings.Name,
                UDim2.new(1, -80, 1, 0),
                UDim2.new(0, 10, 0, 0),
                14, true
            )
            
            -- Toggle Switch
            local Switch = CreateFrame(Toggle,
                UDim2.new(0, 50, 0, 25),
                UDim2.new(1, -60, 0.5, -12.5),
                GetTheme().CardHover,
                25
            )
            Switch.AnchorPoint = Vector2.new(0, 0.5)
            
            local Knob = CreateFrame(Switch,
                UDim2.new(0, 20, 0, 20),
                UDim2.new(0, 3, 0.5, -10),
                GetTheme().Text,
                25
            )
            Knob.AnchorPoint = Vector2.new(0, 0.5)
            
            local ToggleBtn = Instance.new("TextButton")
            ToggleBtn.Size = UDim2.new(1, 0, 1, 0)
            ToggleBtn.BackgroundTransparency = 1
            ToggleBtn.Text = ""
            ToggleBtn.Parent = Toggle
            
            local State = settings.CurrentValue or false
            
            local function UpdateToggle()
                if State then
                    CreateTween(Knob, {
                        Position = UDim2.new(1, -23, 0.5, -10),
                        BackgroundColor3 = GetTheme().Primary
                    }):Play()
                else
                    CreateTween(Knob, {
                        Position = UDim2.new(0, 3, 0.5, -10),
                        BackgroundColor3 = GetTheme().Text
                    }):Play()
                end
            end
            
            UpdateToggle()
            
            -- Click
            ToggleBtn.MouseButton1Click:Connect(function()
                State = not State
                UpdateToggle()
                
                if settings.Callback then
                    pcall(settings.Callback, State)
                end
            end)
            
            local ToggleObj = {}
            function ToggleObj:Set(value)
                State = value
                UpdateToggle()
            end
            
            return ToggleObj
        end
        
        -- Create Label
        function Tab:CreateLabel(text)
            local Label = CreateFrame(TabContent,
                UDim2.new(1, 0, 0, 30),
                UDim2.new(0, 0, 0, 0),
                GetTheme().Card,
                6
            )
            
            CreateLabel(Label, text,
                UDim2.new(1, -20, 1, 0),
                UDim2.new(0, 10, 0, 0),
                14, false
            )
            
            local LabelObj = {}
            function LabelObj:Set(newText)
                if Label:FindFirstChildWhichIsA("TextLabel") then
                    Label:FindFirstChildWhichIsA("TextLabel").Text = newText
                end
            end
            
            return LabelObj
        end
        
        table.insert(Tabs, Tab)
        return Tab
    end
    
    -- Window Controls
    function Window:Hide()
        CreateTween(Main, {Position = UDim2.new(0.5, 0, 1.5, 0)}):Play()
    end
    
    function Window:Show()
        CreateTween(Main, {Position = UDim2.new(0.5, 0, 0.5, 0)}):Play()
    end
    
    -- Keybind
    if settings.ToggleKey then
        UserInputService.InputBegan:Connect(function(input, processed)
            if not processed and input.KeyCode == Enum.KeyCode[settings.ToggleKey] then
                if Main.Position.Y.Offset > 1 then
                    Window:Show()
                else
                    Window:Hide()
                end
            end
        end)
    end
    
    return Window
end

return Rayfield
